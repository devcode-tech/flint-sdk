<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Flint SDK Demo</title>
	</head>
	<body>
		<div class="container mx-auto p-4">
			<h1 class="text-2xl font-bold mb-4">Flint SDK Demo</h1>

			<!-- Flint Form -->
			<div class="p-6 rounded-lg shadow-md mb-8 bg-red-50">
				<flint-form id="my-form"></flint-form>
			</div>

			<!-- Loading State -->
			<div id="loading" class="text-center py-4">
				<p>Loading form...</p>
			</div>

			<!-- Error State -->
			<div id="error" class="hidden text-red-600 p-4 rounded bg-red-50 mb-4">
				<p>Error loading form. Please try again later.</p>
				<pre id="error-details" class="text-xs mt-2 text-red-500"></pre>
			</div>

			<!-- Existing test components -->
			<div class="mt-8">
				<h2 class="text-xl font-semibold mb-4">Test Components</h2>
				<test-component name="Pippo"></test-component>
				<test2-component name="Pluto"></test2-component>
				<p class="mt-2 text-gray-600">
					This section is not affected by the component styles
				</p>
			</div>
		</div>

		<!-- Import the Flint SDK and initialize the form -->
		<script type="module">
			import { FlintSDK } from '/dist/flint-sdk.js';

			// Get the form ID from URL or use a default
			const urlParams = new URLSearchParams(window.location.search);
			const formId =
				urlParams.get('formId') || 'c6994dfc-de19-48fe-8674-64bea10d0d13';

			// Initialize the SDK with configuration
			const flint = new FlintSDK({
				supabaseUrl: import.meta.env.VITE_SUPABASE_URL || '',
				supabaseKey: import.meta.env.VITE_SUPABASE_ANON_KEY || '',
			});

			document.addEventListener('DOMContentLoaded', async () => {
				const form = document.getElementById('my-form');
				const loadingEl = document.getElementById('loading');
				const errorEl = document.getElementById('error');
				const errorDetails = document.getElementById('error-details');

				try {
					console.log(formId);

					// Load the schema from Supabase
					const schema = await flint.loadSchema(formId);

					// Set the schema on the form
					if (form) {
						form.schema = schema;
					}

					// Hide loading state
					if (loadingEl) loadingEl.style.display = 'none';

					// Add form submission handler
					if (form) {
						form.addEventListener('submit', async e => {
							debugger;
							e.preventDefault(); // Prevent default form submission

							const submitButton = form.querySelector('button[type="submit"]');
							const originalButtonText = submitButton?.textContent;

							try {
								// Show loading state
								if (submitButton) {
									submitButton.disabled = true;
									submitButton.innerHTML = 'Submitting...';
								}

								// Get form data
								const formData = form.formData;
								const schemaId = new URLSearchParams(
									window.location.search
								).get('formId');

								// Here you can manipulate formData if needed before submission
								// For example: formData.processed = true;

								// Submit the form
								const response = await flint.submitForm(schemaId, formData);
								console.log('Form submitted successfully:', response);

								// Show success message or redirect
								alert('Form submitted successfully!');
							} catch (error) {
								console.error('Failed to submit form:', error);
								alert('Failed to submit form. Please try again.');
							} finally {
								// Reset button state
								if (submitButton) {
									submitButton.disabled = false;
									submitButton.textContent = originalButtonText;
								}
							}
						});
					}
				} catch (error) {
					console.error('Failed to load form:', error);
					if (loadingEl) loadingEl.style.display = 'none';
					if (errorEl) {
						errorEl.classList.remove('hidden');
						if (errorDetails) {
							errorDetails.textContent =
								error.message || 'Unknown error occurred';
						}
					}
				}
			});
		</script>

		<!-- Existing component scripts -->
		<script type="module" src="/src/test/test.component.ts"></script>
		<script type="module" src="/src/test2/test2.component.ts"></script>
	</body>
</html>
